<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Page d'inscription" />
    <meta name="author" content="" />
    <title>Inscription - Tshirt Shop</title>
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}" />
</head>

<body>
    <!-- Navigation-->
    <div th:replace="~{fragments/header :: header}"></div>

    <!-- Registration Section -->
    <section class="py-5">
        <div class="container px-4 px-lg-5">
            <div class="row justify-content-center">
                <div class="col-lg-8 col-xl-6">
                    <h1 class="text-center mb-5">Créer un compte</h1>
                    <div id="response-message" class="mb-4 text-center fw-bold"></div>

                    <form id="registration-form" method="post" novalidate>
                        <!-- CSRF Token -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrf-token" />

                        <!-- User Details -->
                        <div class="mb-3">
                            <label for="prenom" class="form-label">Prénom</label>
                            <input type="text" id="prenom" name="prenom" class="form-control">
                            <div id="error-prenom" class="form-text text-danger"></div>
                        </div>

                        <div class="mb-3">
                            <label for="nom" class="form-label">Nom</label>
                            <input type="text" id="nom" name="nom" class="form-control">
                            <div id="error-nom" class="form-text text-danger"></div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" id="email" name="email" class="form-control">
                            <div id="error-email" class="form-text text-danger"></div>
                        </div>

                        <div class="mb-3">
                            <label for="motDePasse" class="form-label">Mot de passe</label>
                            <input type="password" id="motDePasse" name="motDePasse" class="form-control">
                            <div id="error-motDePasse" class="form-text text-danger"></div>
                        </div>

                        <hr class="my-4">

                        <!-- Address Details -->
                        <h4 class="mb-3">Adresse</h4>

                        <div class="mb-3">
                             <label for="adresse.libelle" class="form-label">Libellé de l'adresse (ex: Domicile, Travail)</label>
                             <input type="text" id="adresse.libelle" name="adresse.libelle" class="form-control" value="Principale">
                             <div id="error-adresse.libelle" class="form-text text-danger"></div>
                        </div>

                        <div class="mb-3">
                            <label for="adresse.rue" class="form-label">Rue</label>
                            <input type="text" id="adresse.rue" name="adresse.rue" class="form-control">
                            <div id="error-adresse.rue" class="form-text text-danger"></div>
                        </div>

                        <div class="row">
                            <div class="col-md-5 mb-3">
                                <label for="adresse.codePostal" class="form-label">Code Postal</label>
                                <input type="text" id="adresse.codePostal" name="adresse.codePostal" class="form-control">
                                <div id="error-adresse.codePostal" class="form-text text-danger"></div>
                            </div>
                            <div class="col-md-7 mb-3">
                                <label for="adresse.ville" class="form-label">Ville</label>
                                <input type="text" id="adresse.ville" name="adresse.ville" class="form-control">
                                <div id="error-adresse.ville" class="form-text text-danger"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="adresse.pays" class="form-label">Pays</label>
                            <input type="text" id="adresse.pays" name="adresse.pays" class="form-control" value="France">
                            <div id="error-adresse.pays" class="form-text text-danger"></div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button class="btn btn-primary btn-lg" type="submit">S'inscrire</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer-->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    $(document).ready(function() {
        $('#registration-form').on('submit', function(e) {
            e.preventDefault(); // Prevent classic submission

            // Clear previous messages
            $('.form-text.text-danger').text('');
            $('#response-message').text('').removeClass('text-success text-danger');

            const formData = {
                prenom: $('#prenom').val(),
                nom: $('#nom').val(),
                email: $('#email').val(),
                motDePasse: $('#motDePasse').val(),
                adresse: {
                    rue: $('#adresse\\.rue').val(),
                    codePostal: $('#adresse\\.codePostal').val(),
                    ville: $('#adresse\\.ville').val(),
                    pays: $('#adresse\\.pays').val(),
                    libelle: $('#adresse\\.libelle').val()
                }
            };

            const csrfToken = $('#csrf-token').val();
            const csrfHeader = 'X-CSRF-TOKEN';

            $.ajax({
                type: 'POST',
                url: '/register',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {
                    $('#response-message').addClass('text-success').text('Inscription réussie! Vous pouvez maintenant vous connecter.');
                    $('#registration-form')[0].reset(); // Clear the form
                },
                error: function(xhr) {
                    $('#response-message').addClass('text-danger').text('Erreur lors de l\'inscription. Veuillez corriger les champs en erreur.');
                    if (xhr.responseJSON) {
                        const errors = xhr.responseJSON;
                        $.each(errors, function(key, value) {
                            // jQuery requires escaping dots in selectors
                            $('#error-' + key.replace(/\./g, '\\.')).text(value);
                        });
                    }
                }
            });
        });
    });
    </script>
</body>
</html> 