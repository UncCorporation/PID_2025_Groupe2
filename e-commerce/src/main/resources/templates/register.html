<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Inscription - Test</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
        body {
            display: -ms-flexbox;
            display: -webkit-box;
            display: flex;
            -ms-flex-align: center;
            -ms-flex-pack: center;
            -webkit-box-align: center;
            align-items: center;
            -webkit-box-pack: center;
            justify-content: center;
            padding-top: 40px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }
        .form-signin{
            width: 100%;
            max-width: 600px;
            padding: 15px;
            margin: 0 auto;
        }
        .form-label-group {
            position: relative;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

    <form id="registration-form" method="post" class="form-signin">
        <div class="text-center mb-4">
            <a class="badge bg-dark text-white" href="/"><h1>T-Shirt</h1></a>
            <h2>Page d'inscription</h2>
        </div>
        <!-- Champ CSRF crucial pour la sécurité -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrf-token"/>

        <div class="row">
            <div class="col-md-6">
                <label for="prenom">Prénom:</label>
                <div class="form-label-group">
                    <input type="text" class="form-control" id="prenom" name="prenom">
                    <span id="error-prenom" style="color:red; font-size: 0.8em;"></span>
                </div>
            </div>
            <div class="col-md-6">
                <label for="nom">Nom:</label>
                <div class="form-label-group">
                    <input type="text" class="form-control" id="nom" name="nom">
                    <span id="error-nom" style="color:red; font-size: 0.8em;"></span>
                </div>
            </div>
        </div>
        <div>
            <label for="email">Email:</label>
            <div class="form-label-group">
                <input type="email" id="email" name="email" class="form-control">
                <span id="error-email" style="color:red; font-size: 0.8em;"></span>
            </div>
        </div>
        <div>
            <label for="motDePasse">Mot de passe:</label>
            <div class="form-label-group">
                <input type="password" id="motDePasse" name="motDePasse" class="form-control">
                <span id="error-motDePasse" style="color:red; font-size: 0.8em;"></span>
            </div>
        </div>
        <hr>
        <h3>Adresse</h3>
        <div>
            <label for="adresse.rue">Rue:</label>
            <div class="form-label-group">
                <input type="text" id="adresse.rue" name="adresse.rue" class="form-control">
                <span id="error-adresse.rue" style="color:red; font-size: 0.8em;"></span>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <label for="adresse.codePostal">Code Postal:</label>
                <div class="form-label-group">
                    <input type="text" id="adresse.codePostal" name="adresse.codePostal" class="form-control">
                    <span id="error-adresse.codePostal" style="color:red; font-size: 0.8em;"></span>
                </div>
            </div>
            <div class="col-md-4">
                <label for="adresse.ville">Ville:</label>
                <div class="form-label-group">
                    <input type="text" id="adresse.ville" name="adresse.ville" class="form-control">
                    <span id="error-adresse.ville" style="color:red; font-size: 0.8em;"></span>
                </div>
            </div>
            <div class="col-md-4">
                <label for="adresse.pays">Pays:</label>
                <div class="form-label-group">
                    <input type="text" id="adresse.pays" name="adresse.pays" value="France" class="form-control">
                    <span id="error-adresse.pays" style="color:red; font-size: 0.8em;"></span>
                </div>
            </div>

        </div>
        <div>
            <label for="adresse.libelle">Libellé:</label>
            <div class="form-label-group">
                <input type="text" id="adresse.libelle" name="adresse.libelle" value="Principale" class="form-control">
            </div>
        </div>
        <button type="submit"  class="btn btn-lg btn-primary btn-block">S'inscrire</button>
        <a th:href="@{/login}">Déjà un compte</a>
        <div id="response-message" style="margin-top: 20px; font-weight: bold;"></div>
    </form>



    <!-- Il faut inclure jQuery pour que le script fonctionne. On utilise un CDN pour simplifier. -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
    $(document).ready(function() {
        $('#registration-form').on('submit', function(e) {
            e.preventDefault(); // Empêche la soumission classique

            // Vide les anciens messages
            $('span[id^="error-"]').text('');
            $('#response-message').text('');

            const formData = {
                prenom: $('#prenom').val(),
                nom: $('#nom').val(),
                email: $('#email').val(),
                motDePasse: $('#motDePasse').val(),
                adresse: {
                    rue: $('#adresse\\.rue').val(),
                    codePostal: $('#adresse\\.codePostal').val(),
                    ville: $('#adresse\\.ville').val(),
                    pays: $('#adresse\\.pays').val(),
                    libelle: $('#adresse\\.libelle').val()
                }
            };

            const csrfToken = $('#csrf-token').val();
            const csrfHeader = 'X-CSRF-TOKEN';

            $.ajax({
                type: 'POST',
                url: '/register',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function(response) {
                    $('#response-message').css('color', 'green').text('Inscription réussie! Vous pouvez maintenant vous connecter.');
                    $('#registration-form')[0].reset(); // Vide le formulaire
                },
                error: function(xhr) {
                    $('#response-message').css('color', 'red').text('Erreur lors de l\'inscription.');
                    if (xhr.responseJSON) {
                        const errors = xhr.responseJSON;
                        $.each(errors, function(key, value) {
                            // Remplace le point dans les clés comme "adresse.rue" pour que le sélecteur jQuery fonctionne
                            $('#error-' + key.replace('.', '\\.')).text(value);
                        });
                    }
                }
            });
        });
    });
    </script>
</body>
</html> 